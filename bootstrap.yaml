---

- name: Set up ansible remote user
  hosts: all
  remote_user: "{{ bootstrap_username | default('root') }}"
  become: yes
  vars:
    username: "{{ ansible_username }}"
    ssh_public_key_file: "{{ ansible_ssh_public_key_file }}"
    ansible_ssh_private_key_file: "{{ bootstrap_ssh_private_key_file | default(root_ssh_private_key_file) }}"
  roles:
    - role: ansible_access

- name: Set up interactive user
  hosts: dev
  become: yes
  vars:
    username: "{{ interactive_username }}"
    password: "{{ interactive_password }}"
    ssh_public_key_file: "{{ interactive_ssh_public_key_file }}"
    user_groups: "{{ interactive_user_groups }}"
  roles:
    - role: interactive_access
    
- name: Disable ssh login by password and empty passwords
  hosts: all
  become: yes
  vars:
    sshd:
      PermitEmptyPasswords: no
      PasswordAuthentication: no
  roles:
    - role: willshersystems.sshd

- name: Deny all traffic in firewall except ssh connection 
  hosts: all
  become: yes
  tasks:
    - name: Install ufw
      apt:
        name: ufw
        update_cache: yes
    - name: Allow ssh
      community.general.ufw:
        rule: allow
        name: OpenSSH
    - name: Deny other traffic by default
      community.general.ufw:
        default: deny
        state: enabled

- name: Enable TCP BBR congestion control algorithm
  hosts: all
  become: yes
  tasks:
    - name: Set net.core.default_qdisc = fq
      sysctl:
        name: net.core.default_qdisc
        value: fq
        state: present
    - name: Set net.ipv4.tcp_congestion_control = bbr
      sysctl:
        name: net.ipv4.tcp_congestion_control
        value: bbr
        state: present
