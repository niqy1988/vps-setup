---

- name: Set up ansible remote user
  hosts: all
  become: true
  vars:
    ansible_user: "{{ bootstrap_username | default('root') }}"
    ansible_ssh_private_key_file: "{{ bootstrap_ssh_private_key_file | default(root_ssh_private_key_file) }}"
  roles:
    - role: ansible_access

- name: Set up base file system structure
  hosts: all
  become: true
  tasks:
    - name: Create app folder
      file:
        path: /app
        state: directory
    - name: Create data folder, default to be owned by "users" group
      file: 
        path: /data
        state: directory
        group: users
        mode: 02775
    
- name: Use official YUM repositories mirrorlist
  hosts: all
  become: true
  tasks:
    - name: Find all official repo files
      find:
        paths: "/etc/yum.repos.d/"
        patterns: "almalinux-*.repo"
      register: repos
    - name: Enable official mirrorlist
      replace:
        path: "{{ item.path }}"
        regexp: '^#\s*mirrorlist'
        replace: 'mirrorlist'
      loop: "{{ repos.files }}"
      notify:
        - Refresh dnf cache
    - name: Disable mirror baseurl
      replace:
        path: "{{ item.path }}"
        regexp: '^baseurl'
        replace: '# baseurl'
      loop: "{{ repos.files }}"
      notify:
        - Refresh dnf cache
  handlers:
    - name: Refresh dnf cache
      shell: dnf makecache

- name: Enable additional YUM repositories
  hosts: all
  become: true
  tasks:
    - name: Install PowerTools/crb
      dnf:
        name: yum-utils
        state: latest
      notify:
        - Refresh dnf cache
    - name: Enable PowerTools/crb
      community.general.ini_file:
        path: /etc/yum.repos.d/almalinux-crb.repo
        section: crb
        option: enabled
        value: 1
        no_extra_spaces: true
        create: false
      notify:
        - Refresh dnf cache
    - name: Install EPEL
      dnf:
        name: epel-release
        state: latest
      notify:
        - Refresh dnf cache
    - name: Enable EPEL
      community.general.ini_file:
        path: /etc/yum.repos.d/epel.repo
        section: epel
        option: enabled
        value: 1
        no_extra_spaces: true
        create: false
      notify:
        - Refresh dnf cache
  handlers:
    - name: Refresh dnf cache
      shell: dnf makecache

- name: Install and update critical packages 
  hosts: all
  become: true
  tasks:
    - name: Install Chinese locale
      dnf:
        name: langpacks-core-zh_CN.noarch
        state: latest
    - name: Install Python
      dnf:
        name: python3-pip
        state: latest
    - name: Update existing packages
      dnf:
        name: "*"
        state: latest
        
- name: Disable ssh login by password and empty passwords
  hosts: all
  become: true
  vars:
    sshd:
      PermitEmptyPasswords: false
      PasswordAuthentication: false
  roles:
    - role: willshersystems.sshd

- name: Enable TCP BBR congestion control algorithm
  hosts: all
  become: true
  tasks:
    - name: Set net.core.default_qdisc = fq
      sysctl:
        name: net.core.default_qdisc
        value: fq
        state: present
    - name: Set net.ipv4.tcp_congestion_control = bbr
      sysctl:
        name: net.ipv4.tcp_congestion_control
        value: bbr
        state: present

- name: Initialize firewalld
  hosts: all
  become: true
  tasks:
    - name: Install firewalld
      dnf:
        name: firewalld
        state: latest
      notify:
        - Reload firewalld
    - name: Default service rules
      ansible.posix.firewalld:
        service: "{{ item.service }}"
        state: "{{ item.rule }}"
        permanent: true
      loop:
        - service: ssh
          rule: enabled
        - service: dhcpv6-client
          rule: enabled
        - service: cockpit
          rule: disabled
      notify:
        - Reload firewalld
    - name: Start firewalld service
      systemd:
        name: firewalld
        enabled: true
        state: started
      notify:
        - Reload firewalld
  handlers:
    - name: Reload firewalld
      systemd:
        name: firewalld
        enabled: true
        state: reloaded

- name: Set up interactive user
  hosts: dev
  become: true
  vars:
    interactive_sudoer: true
    interactive_user_groups:
      - users
  roles:
    - role: interactive_access
